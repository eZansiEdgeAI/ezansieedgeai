name: Autonomous Agent Execution

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Execution mode'
        required: true
        type: choice
        options:
          - 'sprint-planning'
          - 'execute-tasks'
          - 'create-adr'
          - 'full-autonomous'
        default: 'sprint-planning'
      sprint_duration:
        description: 'Sprint duration in days'
        required: false
        default: '14'
  schedule:
    # Run weekly on Monday at 9 AM UTC to check for new work
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  sprint-planning:
    name: Generate Sprint Plan from Vision
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      github.event.inputs.mode == 'sprint-planning' ||
      github.event.inputs.mode == 'full-autonomous'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pyyaml
      
      - name: Extract tasks from vision
        run: |
          chmod +x tools/agent-orchestration/vision-task-extractor.py
          python tools/agent-orchestration/vision-task-extractor.py \
            --repo-root . \
            --output tools/agent-orchestration/current-sprint.yaml
      
      - name: Upload sprint plan
        uses: actions/upload-artifact@v3
        with:
          name: sprint-plan
          path: tools/agent-orchestration/current-sprint.yaml
      
      - name: Create sprint planning issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');
            
            // Read the generated sprint plan
            const sprintPlan = yaml.load(
              fs.readFileSync('tools/agent-orchestration/current-sprint.yaml', 'utf8')
            );
            
            // Create issue with sprint plan
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Sprint Plan: ${sprintPlan.sprint_goal}`,
              body: `## ðŸŽ¯ Sprint Goal
              
              ${sprintPlan.sprint_goal}
              
              ## ðŸ“… Duration
              ${sprintPlan.duration_days} days
              
              ## ðŸ“¦ Epics (${sprintPlan.epics.length})
              ${sprintPlan.epics.map(epic => 
                `- **${epic.id}**: ${epic.title} (${epic.priority})\n  - Goal: ${epic.goal}`
              ).join('\n')}
              
              ## âœ… Tasks (${sprintPlan.tasks.length})
              ${sprintPlan.tasks.slice(0, 10).map(task => 
                `- [ ] ${task.id}: ${task.description} (${task.agent_type})`
              ).join('\n')}
              ${sprintPlan.tasks.length > 10 ? `\n... and ${sprintPlan.tasks.length - 10} more tasks` : ''}
              
              ## ðŸŽ¯ Alignment with Vision
              - Vision Goals: ${sprintPlan.alignment.vision_goals.join(', ')}
              - Success Criteria: ${sprintPlan.alignment.success_criteria.join(', ')}
              
              ---
              
              **Next Steps:**
              - [ ] Review sprint plan
              - [ ] Assign agents to tasks
              - [ ] Trigger autonomous execution
              
              Use \`gh workflow run autonomous-agent-execution.yml -f mode=execute-tasks\` to start execution.
              `,
              labels: ['sprint-planning', 'autonomous-agent', 'planning']
            });
            
            console.log(`Created sprint planning issue #${issue.number}`);
            
            // Set output for next job
            core.setOutput('issue_number', issue.number);

  detect-adr-needs:
    name: Detect ADR Requirements
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.mode == 'create-adr' ||
      github.event.inputs.mode == 'full-autonomous'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Analyze recent changes for ADR needs
        id: analyze
        run: |
          echo "Checking recent commits for architectural decisions..."
          
          # Look for architectural keywords in recent commits
          recent_commits=$(git log --since="7 days ago" --grep="architecture\|design\|decision\|ADR" --oneline)
          
          if [ -n "$recent_commits" ]; then
            echo "found_decisions=true" >> $GITHUB_OUTPUT
            echo "Found potential architectural decisions:"
            echo "$recent_commits"
          else
            echo "found_decisions=false" >> $GITHUB_OUTPUT
            echo "No architectural decisions detected"
          fi
      
      - name: Check for missing ADRs
        if: steps.analyze.outputs.found_decisions == 'true'
        run: |
          echo "Suggesting ADR creation for recent architectural changes..."
          
          # Create a report of potential ADRs needed
          cat > adr-suggestions.md << 'EOF'
          # ADR Suggestions
          
          Based on recent activity, the following ADRs might be needed:
          
          ## Recent Architectural Changes
          
          EOF
          
          git log --since="7 days ago" --format="- %s (%h)" >> adr-suggestions.md
          
          cat adr-suggestions.md
      
      - name: Create ADR suggestion issue
        if: steps.analyze.outputs.found_decisions == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const suggestions = fs.readFileSync('adr-suggestions.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“‹ ADR Creation Needed',
              body: `${suggestions}\n\n---\n\nPlease review and create appropriate ADRs using:\n\`\`\`\ngh workflow run adr-generation.yml\n\`\`\``,
              labels: ['adr', 'documentation', 'automated-detection']
            });

  agent-coordination:
    name: Coordinate Agent Execution
    runs-on: ubuntu-latest
    needs: [sprint-planning]
    if: |
      github.event.inputs.mode == 'execute-tasks' ||
      github.event.inputs.mode == 'full-autonomous'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download sprint plan
        uses: actions/download-artifact@v3
        with:
          name: sprint-plan
          path: .
      
      - name: Setup coordination
        run: |
          echo "Setting up agent coordination system..."
          
          # Create agent coordination state
          mkdir -p .agent-state
          
          cat > .agent-state/coordination.yaml << 'EOF'
          status: initialized
          agents_active: []
          tasks_assigned: []
          last_sync: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          EOF
      
      - name: Create coordination issue
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## ðŸ¤– Agent Coordination Initialized
            
            The autonomous agent system is now ready to execute tasks.
            
            ### Available Agents
            - Autonomous Sprint Driver
            - Multi-Agent Collaboration Agent  
            - Task Breakdown Agent
            - Enforcement Agents
            
            ### Next Steps
            - [ ] Agents will pick up tasks from the sprint plan
            - [ ] Progress will be tracked automatically
            - [ ] ADRs will be generated as decisions are made
            - [ ] Coordination happens via issues and PRs
            
            ### Monitoring
            Watch for issues labeled \`agent-execution\` for updates.
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– Autonomous Agent System Active',
              body: message,
              labels: ['agent-coordination', 'autonomous-system']
            });

  status-report:
    name: Generate Status Report
    runs-on: ubuntu-latest
    needs: [sprint-planning, detect-adr-needs, agent-coordination]
    if: always()
    
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ðŸŽ¯ Autonomous Agent System Status
            
            ### Actions Completed
            ${needs['sprint-planning'].result === 'success' ? 'âœ…' : 'âŒ'} Sprint Planning
            ${needs['detect-adr-needs'].result === 'success' ? 'âœ…' : needs['detect-adr-needs'].result === 'skipped' ? 'â­ï¸' : 'âŒ'} ADR Detection
            ${needs['agent-coordination'].result === 'success' ? 'âœ…' : needs['agent-coordination'].result === 'skipped' ? 'â­ï¸' : 'âŒ'} Agent Coordination
            
            ### System Status
            The autonomous agent system is configured to:
            - ðŸ“‹ Generate sprint plans from vision and backlog
            - ðŸ¤– Coordinate agent execution
            - ðŸ“ Detect when ADRs are needed
            - âœ… Track progress automatically
            
            ### Resources
            - [Communication Protocol](.github/agents/communication-protocol.md)
            - [Sprint Driver Agent](.github/agents/mutagen-agents/autonomous-sprint-driver.md)
            - [Product Vision](docs/product/vision.md)
            
            ---
            Generated by Autonomous Agent Execution workflow
            `;
            
            await core.summary.addRaw(summary).write();
